<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S73T45U665">grad_u0</span> = giveGradient(<span class="var type1" id="S74T44U668">stress</span>,<span class="var type1" id="S75T10U669">u0_loc</span>,<span class="var type1" id="S76T12U670">trafo</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="comment">% 'stress' here means just a transposed gradient matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="mxinfo" id="T44:U5"><span class="var type1" id="S77T44U673">temp</span> = <span class="mxinfo" id="T44:U7">zeros(<span class="mxinfo" id="T14:U8">size(<span class="var type1" id="S74T44U678">stress</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%     fun = @(block_struct) block_struct.data\eye(2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%     trafo = blockproc(trafo,[2 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">    <span class="mxinfo" id="T12:U10"><span class="var type1" id="S76T12U681">trafo</span> = <span class="mxinfo" id="T12:U12"><span class="fcn" id="F50N8:B683">invertBlock2by2</span>(<span class="var type1" id="S76T12U684">trafo</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">%     trafoCell = mat2cell(trafo,2, 2*ones(  1,size(trafo,2)/2  ) );</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%     trafoCell = blkdiag(trafoCell{:});</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo" id="T12:U14"><span class="var type1" id="S81T12U687">trafoCell</span> = <span class="mxinfo" id="T12:U16"><span class="fcn" id="F51N11:B689">makeBlockDiag2by2</span>(<span class="var type1" id="S76T12U690">trafo</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo" id="T11:U18"><span class="var type1" id="S74T11U693">stress</span> = <span class="mxinfo" id="T11:U20"><span class="var type1" id="S74T44U695">stress</span>*<span class="var type1" id="S81T12U696">trafoCell</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S83T2U699">i</span>=<span class="mxinfo" id="T2:U24">1</span>:0.5*length(<span class="var type1" id="S75T10U706">u0_loc</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">        <span class="mxinfo" id="T33:U26"><span class="var type1" id="S85T33U709">D</span> = <span class="mxinfo" id="T33:U28">diag(<span class="mxinfo" id="T32:U29">[<span class="mxinfo" id="T49:U30"><span class="var type1" id="S75T10U715">u0_loc</span>(<span class="mxinfo" id="T49:U32"><span class="mxinfo" id="T2:U33"><span class="mxinfo" id="T2:U34">2</span>*<span class="var type1" id="S83T2U720">i</span>-1</span>:<span class="mxinfo" id="T2:U36">2</span>*<span class="var type1" id="S83T2U724">i</span></span>)</span> ; <span class="mxinfo" id="T49:U38"><span class="var type1" id="S75T10U727">u0_loc</span>(<span class="mxinfo" id="T49:U40"><span class="mxinfo" id="T2:U41"><span class="mxinfo" id="T2:U42">2</span>*<span class="var type1" id="S83T2U732">i</span>-1</span>:<span class="mxinfo" id="T2:U44">2</span>*<span class="var type1" id="S83T2U736">i</span></span>)</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="comment">%         fun = @(block_struct) D*block_struct.data;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"><span class="comment">%         temp(4*i-3:4*i,:) = blockproc(stress(4*i-3:4*i,:),[4 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">        <span class="mxinfo" id="T60:U46"><span class="mxinfo" id="T60:U47"><span class="var type1" id="S77T44U740">temp</span>(<span class="mxinfo" id="T32:U49"><span class="mxinfo" id="T2:U50"><span class="mxinfo" id="T2:U51">4</span>*<span class="var type1" id="S83T2U745">i</span>-3</span>:<span class="mxinfo" id="T2:U53">4</span>*<span class="var type1" id="S83T2U749">i</span></span>,:)</span> = <span class="mxinfo" id="T34:U55"><span class="var type1" id="S85T33U752">D</span>*<span class="mxinfo" id="T34:U57"><span class="var type1" id="S74T11U754">stress</span>(<span class="mxinfo" id="T32:U59"><span class="mxinfo" id="T2:U60"><span class="mxinfo" id="T2:U61">4</span>*<span class="var type1" id="S83T2U759">i</span>-3</span>:<span class="mxinfo" id="T2:U63">4</span>*<span class="var type1" id="S83T2U763">i</span></span>,:)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">    <span class="mxinfo" id="T45:U65"><span class="var type1" id="S73T45U767">grad_u0</span> = <span class="mxinfo" id="T45:U67">[<span class="mxinfo" id="T46:U68">sum(<span class="mxinfo" id="T44:U69"><span class="var type1" id="S77T44U773">temp</span>(<span class="mxinfo" id="T13:U71"><span class="mxinfo" id="T2:U72">1</span>:<span class="mxinfo" id="T2:U73">2</span>:<span class="mxinfo" id="T2:U74">end</span></span>,:)</span>)</span> ; <span class="mxinfo" id="T46:U75">sum(<span class="mxinfo" id="T44:U76"><span class="var type1" id="S77T44U785">temp</span>(<span class="mxinfo" id="T13:U78"><span class="mxinfo" id="T2:U79">2</span>:<span class="mxinfo" id="T2:U80">2</span>:<span class="mxinfo" id="T2:U81">end</span></span>,:)</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"></span></span>
</pre>
