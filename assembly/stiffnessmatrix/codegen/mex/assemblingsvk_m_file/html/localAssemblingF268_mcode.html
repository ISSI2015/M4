<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S33T36U375">F</span> = localAssemblingF(<span class="var type1" id="S34T45U378">grad_u0</span>,<span class="var type1" id="S35T45U379">sigma_u0</span>,<span class="var type1" id="S36T43U380">gradientMatBase</span>,<span class="var type1" id="S37T12U381">trafo</span>,<span class="var type1" id="S38T38U382">weights</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">    <span class="mxinfo" id="T2:U7"><span class="var type1" id="S39T2U385">N</span> = <span class="mxinfo" id="T2:U9">length(<span class="var type1" id="S38T38U388">weights</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%     fun = @(block_struct) abs(det(block_struct.data));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%     trafoDet = blockproc(trafo,[2 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">    <span class="mxinfo" id="T2:U11"><span class="var type1" id="S41T2U391">trafoDet</span> = <span class="mxinfo" id="T2:U13"><span class="fcn" id="F230N17:B393">trafoDeterminant</span>(<span class="var type1" id="S37T12U394">trafo</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">    <span class="comment">%weights = weights.*trafoDet;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S43T2U397">i</span>=<span class="mxinfo" id="T2:U16">1</span>:<span class="var type1" id="S39T2U400">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">        <span class="mxinfo" id="T2:U18"><span class="mxinfo" id="T2:U19"><span class="var type1" id="S38T38U404">weights</span>(<span class="var type1" id="S43T2U405">i</span>)</span> = <span class="mxinfo" id="T2:U22"><span class="mxinfo" id="T2:U23"><span class="var type1" id="S38T38U408">weights</span>(<span class="var type1" id="S43T2U409">i</span>)</span>*<span class="mxinfo" id="T2:U26"><span class="var type1" id="S41T2U411">trafoDet</span>(<span class="var type1" id="S43T2U412">i</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">     <span class="keyword">for</span> <span class="var type1" id="S43T2U415">i</span>=<span class="mxinfo" id="T2:U30">1</span>:<span class="var type1" id="S39T2U418">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">        <span class="mxinfo" id="T12:U32"><span class="var type1" id="S44T12U421">inv</span> = <span class="mxinfo" id="T12:U34"><span class="mxinfo" id="T12:U35"><span class="var type1" id="S37T12U424">trafo</span>(:,<span class="mxinfo" id="T49:U37"><span class="mxinfo" id="T2:U38"><span class="mxinfo" id="T2:U39">2</span>*<span class="var type1" id="S43T2U430">i</span>-1</span>:<span class="mxinfo" id="T2:U41">2</span>*<span class="var type1" id="S43T2U434">i</span></span>)</span>\<span class="mxinfo" id="T12:U43">eye(2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">%         fun = @(block_struct) block_struct.data*(inv) * weights(i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">%         gradientMatBase(2*i-1:2*i,:) = blockproc(gradientMatBase(2*i-1:2*i,:),[2 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        <span class="mxinfo" id="T4:U44"><span class="mxinfo" id="T4:U45"><span class="var type1" id="S36T43U441">gradientMatBase</span>(<span class="mxinfo" id="T49:U47"><span class="mxinfo" id="T2:U48"><span class="mxinfo" id="T2:U49">2</span>*<span class="var type1" id="S43T2U446">i</span>-1</span>:<span class="mxinfo" id="T2:U51">2</span>*<span class="var type1" id="S43T2U450">i</span></span>,:)</span> = <span class="mxinfo" id="T4:U53"><span class="fcn" id="F231N7:B453">gradientMatBaseFun</span>(<span class="mxinfo" id="T4:U54"><span class="var type1" id="S36T43U455">gradientMatBase</span>(<span class="mxinfo" id="T49:U56"><span class="mxinfo" id="T2:U57"><span class="mxinfo" id="T2:U58">2</span>*<span class="var type1" id="S43T2U460">i</span>-1</span>:<span class="mxinfo" id="T2:U60">2</span>*<span class="var type1" id="S43T2U464">i</span></span>,:)</span>,<span class="var type1" id="S44T12U466">inv</span>,<span class="mxinfo" id="T2:U63"><span class="var type1" id="S38T38U468">weights</span>(<span class="var type1" id="S43T2U469">i</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo" id="T45:U66"><span class="var type1" id="S34T45U472">grad_u0</span> = <span class="mxinfo" id="T45:U68"><span class="mxinfo" id="T45:U69">repmat(eye(2),1,<span class="mxinfo" id="T2:U70"><span class="mxinfo" id="T2:U71">0.5</span>*<span class="mxinfo" id="T2:U72">size(<span class="var type1" id="S34T45U484">grad_u0</span>,2)</span></span>)</span> + <span class="var type1" id="S34T45U486">grad_u0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">%     sigmaCell = mat2cell(sigma_u0,2,2*ones(1,size(grad_u0,2)/2));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">%     sigmaCell = blkdiag(sigmaCell{:});</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="mxinfo" id="T47:U75"><span class="var type1" id="S49T47U489">sigmaCell</span> = <span class="mxinfo" id="T47:U77"><span class="fcn" id="F247N11:B491">makeBlockDiag2by2</span>(<span class="var type1" id="S35T45U492">sigma_u0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    <span class="mxinfo" id="T45:U79"><span class="var type1" id="S51T45U495">stress</span> = <span class="mxinfo" id="T4:U81"><span class="var type1" id="S34T45U497">grad_u0</span>*<span class="var type1" id="S49T47U498">sigmaCell</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">%     fun = @(block_struct) block_struct.data';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">%     stress = blockproc(stress,[2 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    <span class="mxinfo" id="T45:U84"><span class="var type1" id="S51T45U501">stress</span> = <span class="mxinfo" id="T45:U86"><span class="fcn" id="F266N15:B503">stressTranspose</span>(<span class="var type1" id="S51T45U504">stress</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">    <span class="mxinfo" id="T4:U88"><span class="var type1" id="S53T4U507">mat</span> = <span class="mxinfo" id="T4:U90"><span class="var type1" id="S51T45U509">stress</span>*<span class="var type1" id="S36T43U510">gradientMatBase</span></span></span>; <span class="comment">% size is 2-by-2*k</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">%      fun = @(block_struct) trace(block_struct.data);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">%      F = blockproc(mat,[2 2],fun);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">     <span class="mxinfo" id="T36:U93"><span class="var type1" id="S33T36U513">F</span> = <span class="mxinfo" id="T36:U95"><span class="fcn" id="F267N12:B515">matrixTraceFun</span>(<span class="var type1" id="S53T4U516">mat</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"></span></span>
</pre>
